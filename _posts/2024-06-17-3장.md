---
layout: post
title: 3장 전송계층
category: lecturenote
---
3장 전송 계층



# 3장 전송 계층

## 전송 계층 서비스
앱 프로세스간 논리적 소통

종단 시스템에서만 작동하는 프로토콜이다 .

## 인터넷 전송 계층 프로토콜
TCP: 의존 가능, 순차적 전송  
보내고 받았는지 확인  
큰 데이터를 잘라 보냄, 순서는 인덱스로  

UDP: 비 의존적, 비 순차적 전송  
best-effort IP
  	순서와 무결성 어떤 것도 보장하지 않음  

### multiplexing/demultiplexing
multiplexing: 같은 경로에 여러 data를 여러개 섞어 보냄
demultiplexing: 섞인 data를 분리

## UDP 전송 프로토콜 임무
- 포트 번호를 이용하여 프로세스간 통신을 생성
- 최소한의 오류 제어 메커니즘 실행 - 전송은 책임지지 않는다
- 최소한의 오버헤드만 사용하는 간단한 프로토콜
- 에러, 손실, 순서에 책임지지 않는다
### UDP 특징
- 비연결형
	- 데이터 전송 전에 연결을 설정하지 않는다
- 비상태정보
	- 연결에 대한 상태 정보를 보관하지 않는다
- 비정규적 송신률
	- 패킷 손실이 발생하더라도 지속적으로 최소 전송률을 요구하는 실시간 영상 서비스에 적합
- best effort 서비스
	- 수신 확인 및 재전송 기능이 없다
### UDP 사용처
- DNS
- SNMP

### 단점 해결책
UDP가 아닌 클라이언트의 어플리케이션 계층에서 받았는지 아닌지 확힌하는 응용 프로그램으로 처리한다.

![[Pasted image 20240426125843.png]]  

### UDP checksum
목적: 전송 과정에서 발생하는 에러를 탐지

수신측: 받은 세그먼트의 checksum를 계산한다.
계산된 checksum의 값이 checksum 필드의 값과 동일한지 확인한다.  
동일하면 에러가 없는 것, 동일하지 않으면 에러가 있는 것

## TCP 흐름 제어

슬라이딩 윈도우

수신 쪽에서 윈도우 크기만큼 송신측에서 확인 응답 없이 전송할 수 있게 하여 흐름을 유동적으로 조절한다

TCP 송신 윈도우 크기: 수신 측으로부터 확인 응답 없이 전송할 수 있는 데이터의 크기

| ACK가 온 데이터 | ACK가 안 온 데이터 (재전송을 위함) | 아직 안보낸 data | 공백  |
| ---- | -------------------------------------------- | --- | --- |

- 윈도우는 유동적
- 수신측에서 통신 상황에 따라 플로우를 조정

### Nagle 알고리즘

전송할 데이터를 어느정도 모아 한번에 전송한다

### 슬로우 스타트(Slow Start)

송신측에서 처음 전송할 때 윈도우의 크기를 1에서 잘 전송되면 2배씩 늘려간다

개수가 증가하다가 트래픽에 걸리면 윈도우 사이즈를 줄인다

## Network Congestion 네트워크 혼잡

망에 입력되는 트래픽의 양이 많아 처리 가능 한도를 초과

인터넷 망에서 트래픽의 흐름이 일정하지 않은 경우

네트워크가 다루기에 너무 많은 소스들에서 너무 빠른 속도로 보내는 경우   

윈도우의 크기가 큰 경우


1. ACK가 안오고 timeout이 되거나 2) ACK가 중복되는 경우 해당

두가지를 같은 것으로 보느냐 다른 것으로 보느냐에 따라 TCP의 혼잡 제어 방식이 나뉜다

혼잡 제어 방식에는 TCP Tahoe, Reno, New Reno 등이 있다. 

## 네트워크 혼잡 해결 방식

### End-to-End 방식

네트워크에서 피드백 없이 TCP에서 독자적으로 해결

라우터의 일이 많아지기 때문에 end system인 TCP선에서 해결

### Network-assisted 방식

네트워크 계층의 라우터가 TCP에게 피드백 제공
IP 측에서 지연 상태를 TCP에게 알려주면 수신쪽에서 ECE와 ACK를 함께 보낸다.

ECE는 ECN-echo, ECE의 플래그이다.
ECN은 Explicit Congestion Notification으로 라우터가 송신 프로세스에 혼잡 발생을 알려 송신 프로세스가 트래픽을 완화하는 기술을 말한다.
## 혼잡 제어 방식
### 예방적 혼잡 제어
사전에 네트워크 망에 입력되는 트래픽 양을 조절한다.
라우터에서 패킷을 전송할 때 사전에 약속된 계약에 따라 패킷의 전송 순위를 결정한다.
###  반응적 혼잡 제어
혼잡 발생은 ACK가 손실되거나 중복되거나 등 정상적으로 도착하지 않은 경우 처리한다. 
네트워크에서 체증이 발생할 시 트래픽을 감소시킨다.
1. Detection
	패킷의 지연 시간, 라우터 버퍼 등을 계속 측정하여 Congestion을 발견한다.
2. Rate Control
	트래픽을 과도하게 유발하는 호스트들이 패킷 전송을 조절하여 혼잡에 대한 대응을 한다. 

원래 이 과정은 라우터에서 하는 것이 적합하지만 현재는 TCP에서 수행한다.

1. Detection
	TCP가 손신 패킷에 대해 ACK를 전송해야 하는데 timeout까지 도착하지 않으면 혼잡이 발생한 것으로 판단한다.
2. Rate Control
	1. 송신자는 slow start 방식으로 전송한다. (혼잡과 무관하게)
	2. 혼잡이 발생 시 전송되는 패킷의 양을 처음 시점으로 돌린다.

## TCP의 윈도우
### Awnd(advertised window)
수신자쪽의 최대 윈도우 크기, 패킷 수신시 버퍼의 비어있는 공간의 크기
흐름 제어에서 초기 연결 설정 단계시 TCP는 수신자 쪽의 최대 윈도우(버퍼) 크기(초기 awnd)를 알린다.
패킷 수신마다 현재 버퍼 중에서 비어있는 공간의 크기(awnd)를 알린다.
### Cwnd(congestion window)
: TCP가 패킷을 전송할 때 Ack를 받지 않고도 연속으로 보낼 수 있는 윈도우의 크기 
흐름 제어를 위해서는 Awnd만큼 전송 가능하지만 혼잡 제어를 위해서는 Cwnd만큼 전송 가능하다.

- cwnd는 awnd의 최소값만큼 증가할 수 있다.
- cwnd의 크기는 awnd의 크기보다 커질 수 없다.

## 혼잡 회피 방식
### AIMD
cwnd는 1부터 시작해서 손실이 발생하기 전까지 1개씩 증가한다.
손실이 발생하면 cwnd를 1/2로 줄인다.
해결 후 다시 1개씩 증가한다.
=> 이 방법은 혼잡 상태가 발생한 이후에 대역폭을 감소시킨다.

### TCP Slow Start
![[CN12_1.png]]
cwnd를 1부터 2배씩 증가시킨다. 혼잡 현상이 발생하는 경우 이를 1로 줄인다. 
해결 후 다시 2배씩 증가시킨다.

## 혼잡 제어 정책
### TCP Tahoe
![](https://i.imgur.com/7Zscrcm.png)
cwnd가 임계점 도달 이전까지는 2배씩 증가(slow start)하다가 이후로는 1개씩 증가(aimd)한다. 
timeout이나 3 ack 중복 등 혼잡 상황이 발생하는 경우 임계점은 당시 윈도우의 1/2로 줄어든다. 
두 혼잡 상황을 같은 방식으로 처리하기 때문에 Tahoe 방식에서는 빠른 재전송 방식을 사용한다. 

#### 빠른 재전송 (Fast Retransmit)
보통 동일한 ACK를 3개 이하로 받을 경우 심각하지 않은 혼잡으로 판단한다. 3개의 중복 ACK를 받을 경우(3 ack duplicated) timeout이 되기 전이라도 바로 재전송한다. 

### TCP Reno

![](https://i.imgur.com/j9mKJJ4.png)
Timeout과 3 ack 중복을 구분하여 3 ack 중복이 발생하면 AIMD 방식으로, timeout이 발생하면 Slow Start 방식으로 처리한다. 
timeout의 경우 cwnd를 1로 줄이고 임계점은 줄어들지 않는다. 
3 ack 중복의 경우 cwnd를 1/2로 줄이고 임계점도 줄어든 윈도우 크기로 설정한다. -> fast recovery 

#### Fast Recovery
윈도우 크기를 1로 줄이지 않고 1/2로 줄인 뒤 빠르게 회복시키는 것을 말한다.  
임계점은 줄어들었을 때의 윈도우의 값으로 설정된다. 

### TCP New Reno
패킷 손실이 연속으로 발생해도 윈도우 크기를 줄어들지 않는다.
Reno 방식은 손실이 3번 발생하면 윈도우의 크기가 1/8로 줄어들지만 New Reno 방식은 이 손실을 하나의 손실로 판단하여 1/2만 줄어든다. 

#### Cwnd 공평성
TCP 통신 시 New Reno 방식으로 혼잡 제어를 할 경우 점점 공평해져간다.

| 프로세스 | 초기 cwnd | 혼잡 발생 | +10 | 혼잡 발생 | +5  | 혼잡 발생 |
| :--: | :-----: | :---: | :-: | :---: | :-: | :---: |
|  A   |   40    |  20   | 30  |  15   | 20  |  10   |
|  B   |   20    |  10   | 20  |  10   | 15  |   8   |
|  C   |    2    |   1   | 11  |   5   | 10  |   5   |
   
UDP는 윈도우의 사이즈를 조절하지 않는다. 빠른 속도를 위해 일부 손실을 감수한다.

